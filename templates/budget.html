{% extends "base.html" %}

{% block title %}Balance Mensual{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-calculator text-green-500"></i> Balance Mensual
            </h1>
            <p class="text-gray-500 mt-1" id="current-month">Simulación de gastos del mes</p>
        </div>
    </div>

    <!-- Balance Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Ingresos -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
            <p class="text-green-100 text-sm font-medium">Ingresos</p>
            <h2 id="total-income" class="text-3xl font-bold mt-2">$0.00</h2>
            <i class="fas fa-arrow-down text-green-200 text-2xl opacity-50 absolute top-4 right-4"></i>
        </div>

        <!-- Gastos -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
            <p class="text-red-100 text-sm font-medium">Gastos Totales</p>
            <h2 id="total-expenses" class="text-3xl font-bold mt-2">$0.00</h2>
            <i class="fas fa-arrow-up text-red-200 text-2xl opacity-50 absolute top-4 right-4"></i>
        </div>

        <!-- Balance -->
        <div id="balance-card" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <p class="text-blue-100 text-sm font-medium">Balance</p>
            <h2 id="balance-amount" class="text-3xl font-bold mt-2">$0.00</h2>
            <i class="fas fa-balance-scale text-blue-200 text-2xl opacity-50 absolute top-4 right-4"></i>
        </div>

        <!-- Capacidad de Ahorro -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
            <p class="text-purple-100 text-sm font-medium">Capacidad de Ahorro</p>
            <h2 id="savings-capacity" class="text-3xl font-bold mt-2">$0.00</h2>
            <i class="fas fa-piggy-bank text-purple-200 text-2xl opacity-50 absolute top-4 right-4"></i>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Income & Settings -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-cog mr-2 text-blue-500"></i> Configuración
            </h2>

            <div class="space-y-4">
                <!-- Salary Input -->
                <div>
                    <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Salario Mensual</label>
                    <input type="number" id="salary-input" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
                </div>

                <!-- Include Options -->
                <div class="border-t pt-4">
                    <label class="block text-gray-700 dark:text-gray-200 font-medium mb-3">Incluir en simulación:</label>

                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="include-loans" checked class="w-4 h-4 text-primary rounded focus:ring-primary">
                        <label for="include-loans" class="ml-2 text-gray-700 dark:text-gray-200">Pagos de préstamos activos</label>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="include-cards" checked class="w-4 h-4 text-primary rounded focus:ring-primary">
                        <label for="include-cards" class="ml-2 text-gray-700 dark:text-gray-200">Pagos de tarjetas de crédito</label>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="border-t pt-4">
                    <button onclick="saveConfiguration()" class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-save mr-2"></i> Guardar Configuración
                    </button>
                </div>
            </div>
        </div>

        <!-- Fixed Expenses -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-receipt mr-2 text-orange-500"></i> Gastos Fijos
                </h2>
                <button onclick="openAddExpenseModal()" class="bg-orange-500 text-white px-3 py-1 rounded-lg hover:bg-orange-600 transition text-sm">
                    <i class="fas fa-plus mr-1"></i> Agregar
                </button>
            </div>

            <div id="fixed-expenses-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Fixed expenses will be loaded here -->
                <p class="text-gray-400 text-center py-4">No hay gastos fijos registrados</p>
            </div>

            <div class="border-t mt-4 pt-3">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Total:</span>
                    <span id="fixed-expenses-total" class="text-xl font-bold text-orange-600">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Breakdown -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
            <i class="fas fa-chart-pie mr-2 text-purple-500"></i> Desglose de Gastos Mensuales
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Fixed Expenses Card -->
            <div class="border-l-4 border-orange-500 bg-orange-50 rounded-lg p-4">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Gastos Fijos</p>
                <p id="breakdown-fixed" class="text-2xl font-bold text-orange-600">$0.00</p>
                <p class="text-xs text-gray-500 mt-1">Renta, servicios, etc.</p>
            </div>

            <!-- Loans Card -->
            <div class="border-l-4 border-blue-500 bg-blue-50 rounded-lg p-4">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Préstamos</p>
                <p id="breakdown-loans" class="text-2xl font-bold text-blue-600">$0.00</p>
                <p class="text-xs text-gray-500 mt-1">Pagos mensuales</p>
            </div>

            <!-- Credit Cards Card -->
            <div class="border-l-4 border-purple-500 bg-purple-50 rounded-lg p-4">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">Tarjetas de Crédito</p>
                <p id="breakdown-cards" class="text-2xl font-bold text-purple-600">$0.00</p>
                <p class="text-xs text-gray-500 mt-1">Pagos + cuotas MSI</p>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mt-6">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-2">
                <span>Gastos vs Ingresos</span>
                <span id="expense-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="expense-progress-bar" class="h-4 rounded-full transition-all bg-gradient-to-r from-green-500 to-red-500" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div id="expense-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Agregar Gasto Fijo</h2>
        <form id="expense-form" class="space-y-4">
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Concepto *</label>
                <input type="text" id="expense-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ej: Renta, Internet, Luz">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Monto *</label>
                <input type="number" id="expense-amount" required step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
            </div>
            <div class="flex space-x-3 pt-4">
                <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-2"></i> Agregar
                </button>
                <button type="button" onclick="closeExpenseModal()" class="flex-1 bg-gray-300 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let budgetId = null;
    let currentBudget = null;

    // Load initial data
    async function loadBudgetData() {
        try {
            // Load current budget
            const budgetRes = await fetchWithLoader('/api/budget/current');
            currentBudget = await budgetRes.json();
            budgetId = currentBudget.id;

            // Populate form
            document.getElementById('salary-input').value = currentBudget.salary || 0;
            document.getElementById('include-loans').checked = currentBudget.include_loans !== false;
            document.getElementById('include-cards').checked = currentBudget.include_credit_cards !== false;

            // Render fixed expenses
            renderFixedExpenses();

            // Calculate and display balance
            await calculateBalance();
        } catch (error) {
            console.error('Error loading budget:', error);
            showToast('Error al cargar el presupuesto', 'error');
        }
    }

    // Render fixed expenses list
    function renderFixedExpenses() {
        const container = document.getElementById('fixed-expenses-list');
        const expenses = currentBudget.fixed_expenses || [];

        if (expenses.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay gastos fijos registrados</p>';
            return;
        }

        container.innerHTML = expenses.map((exp, index) => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div class="flex-1">
                    <p class="font-medium text-gray-800 dark:text-white">${exp.name}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <p class="font-bold text-orange-600">${formatCurrency(exp.amount)}</p>
                    <button onclick="deleteExpense(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Save configuration
    async function saveConfiguration() {
        if (!budgetId) return;

        const salary = parseFloat(document.getElementById('salary-input').value) || 0;
        const includeLoans = document.getElementById('include-loans').checked;
        const includeCards = document.getElementById('include-cards').checked;

        try {
            const res = await fetchWithLoader(`/api/budget/${budgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    salary: salary,
                    include_loans: includeLoans,
                    include_credit_cards: includeCards
                })
            });

            if (res.ok) {
                showToast('Configuración guardada');
                currentBudget.salary = salary;
                currentBudget.include_loans = includeLoans;
                currentBudget.include_credit_cards = includeCards;
                await calculateBalance();
            }
        } catch (error) {
            console.error('Error saving configuration:', error);
            showToast('Error al guardar', 'error');
        }
    }

    // Calculate balance
    async function calculateBalance() {
        try {
            const res = await fetchWithLoader('/api/budget/calculate');
            const balance = await res.json();

            // Update summary cards
            document.getElementById('total-income').textContent = formatCurrency(balance.salary);
            document.getElementById('total-expenses').textContent = formatCurrency(balance.total_expenses);
            document.getElementById('balance-amount').textContent = formatCurrency(balance.balance);
            document.getElementById('savings-capacity').textContent = formatCurrency(balance.savings_capacity);

            // Update breakdown
            document.getElementById('breakdown-fixed').textContent = formatCurrency(balance.total_fixed_expenses);
            document.getElementById('breakdown-loans').textContent = formatCurrency(balance.loans_payment);
            document.getElementById('breakdown-cards').textContent = formatCurrency(balance.cards_payment);
            document.getElementById('fixed-expenses-total').textContent = formatCurrency(balance.total_fixed_expenses);

            // Update progress bar
            const expensePercent = balance.salary > 0 ? (balance.total_expenses / balance.salary * 100) : 0;
            document.getElementById('expense-percentage').textContent = expensePercent.toFixed(1) + '%';
            document.getElementById('expense-progress-bar').style.width = Math.min(expensePercent, 100) + '%';

            // Update balance card color
            const balanceCard = document.getElementById('balance-card');
            if (balance.balance < 0) {
                balanceCard.className = 'bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white';
            } else if (balance.balance === 0) {
                balanceCard.className = 'bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-6 text-white';
            } else {
                balanceCard.className = 'bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white';
            }

        } catch (error) {
            console.error('Error calculating balance:', error);
            showToast('Error al calcular balance', 'error');
        }
    }

    // Expense modal functions
    function openAddExpenseModal() {
        document.getElementById('expense-form').reset();
        document.getElementById('expense-modal').classList.remove('hidden');
        document.getElementById('expense-modal').classList.add('flex');
    }

    function closeExpenseModal() {
        document.getElementById('expense-modal').classList.add('hidden');
        document.getElementById('expense-modal').classList.remove('flex');
    }

    // Add expense
    document.getElementById('expense-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('expense-name').value;
        const amount = parseFloat(document.getElementById('expense-amount').value) || 0;

        const newExpenses = [...(currentBudget.fixed_expenses || []), { name, amount }];

        try {
            const res = await fetchWithLoader(`/api/budget/${budgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fixed_expenses: newExpenses })
            });

            if (res.ok) {
                showToast('Gasto agregado');
                currentBudget.fixed_expenses = newExpenses;
                renderFixedExpenses();
                closeExpenseModal();
                await calculateBalance();
            }
        } catch (error) {
            console.error('Error adding expense:', error);
            showToast('Error al agregar gasto', 'error');
        }
    });

    // Delete expense
    async function deleteExpense(index) {
        if (!confirm('¿Eliminar este gasto fijo?')) return;

        const newExpenses = currentBudget.fixed_expenses.filter((_, i) => i !== index);

        try {
            const res = await fetchWithLoader(`/api/budget/${budgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fixed_expenses: newExpenses })
            });

            if (res.ok) {
                showToast('Gasto eliminado');
                currentBudget.fixed_expenses = newExpenses;
                renderFixedExpenses();
                await calculateBalance();
            }
        } catch (error) {
            console.error('Error deleting expense:', error);
            showToast('Error al eliminar gasto', 'error');
        }
    }

    // Close modal when clicking outside
    document.getElementById('expense-modal').addEventListener('click', (e) => {
        if (e.target.id === 'expense-modal') {
            closeExpenseModal();
        }
    });

    // Set current month
    const now = new Date();
    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('current-month').textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;

    // Load data on page load
    loadBudgetData();
</script>
{% endblock %}

