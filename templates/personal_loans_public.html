<!DOCTYPE html>
<html lang="es" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√©stamos Compartidos - Vista P√∫blica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0891b2',
                        secondary: '#0ea5e9'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-gray-100 text-gray-800">
    <div class="max-w-4xl mx-auto px-4 py-10 space-y-8">
        <header class="bg-white/80 backdrop-blur rounded-3xl shadow-xl p-6 md:p-8 border border-cyan-50">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <p class="uppercase text-xs tracking-[0.3em] text-cyan-600 font-semibold">Vista compartida</p>
                    <h1 class="text-3xl md:text-4xl font-black text-gray-900 mt-2">
                        Balance de Pr√©stamos Personales
                    </h1>
                    <p class="text-gray-500 mt-3">Revisa el saldo entre amigos y agrega nuevos registros sin ingresar al dashboard completo.</p>
                </div>
                <button id="copy-link" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-primary text-white font-semibold shadow-lg hover:bg-cyan-700 transition">
                    <i class="fas fa-link"></i>
                    Copiar enlace
                </button>
            </div>
            <div class="mt-4 text-xs text-gray-500 flex items-center gap-2">
                <i class="fas fa-info-circle text-cyan-500"></i>
                Solo muestra pr√©stamos personales. No expone otras secciones ni datos sensibles.
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <article class="bg-white rounded-2xl shadow p-5 border border-green-100">
                <p class="text-sm text-green-600 font-semibold">Me deben</p>
                <h2 id="public-pending-lent" class="text-3xl font-black text-gray-900 mt-3">S/ 0.00</h2>
            </article>
            <article class="bg-white rounded-2xl shadow p-5 border border-rose-100">
                <p class="text-sm text-rose-600 font-semibold">Yo debo</p>
                <h2 id="public-pending-borrowed" class="text-3xl font-black text-gray-900 mt-3">S/ 0.00</h2>
            </article>
            <article class="bg-white rounded-2xl shadow p-5 border border-slate-100">
                <p class="text-sm text-slate-600 font-semibold">Balance neto</p>
                <h2 id="public-balance" class="text-3xl font-black text-gray-900 mt-3">S/ 0.00</h2>
                <p id="public-balance-label" class="text-xs text-gray-500 mt-2">Saldo pendiente</p>
            </article>
        </section>

        <section class="bg-white rounded-2xl shadow border border-gray-100 p-6 space-y-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Historial r√°pido</h3>
                    <p class="text-sm text-gray-500">Filtra por estado para ubicar un registro puntual.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-btn px-4 py-2 rounded-full bg-primary text-white text-sm font-semibold" data-filter="all">Todos</button>
                    <button class="filter-btn px-4 py-2 rounded-full bg-gray-100 text-gray-600 text-sm font-semibold" data-filter="pending">Pendientes</button>
                    <button class="filter-btn px-4 py-2 rounded-full bg-gray-100 text-gray-600 text-sm font-semibold" data-filter="paid">Pagados</button>
                </div>
            </div>
            <div id="public-loans-list" class="space-y-3">
                <p class="text-center text-gray-400 text-sm">Cargando registros...</p>
            </div>
        </section>

        <section class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-primary/10 text-primary flex items-center justify-center">
                    <i class="fas fa-plus text-xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Agregar registro</h3>
                    <p class="text-sm text-gray-500">Solo se necesitan los datos b√°sicos para mantener el balance al d√≠a.</p>
                </div>
            </div>
            <form id="public-loan-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="text-sm font-semibold text-gray-600">Tipo *</label>
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <label class="inline-flex items-center gap-2 border border-gray-200 rounded-2xl px-4 py-3 cursor-pointer hover:border-primary">
                            <input type="radio" name="type" value="lent" class="text-primary" checked>
                            <span class="text-sm font-semibold">Yo pagu√©</span>
                        </label>
                        <label class="inline-flex items-center gap-2 border border-gray-200 rounded-2xl px-4 py-3 cursor-pointer hover:border-primary">
                            <input type="radio" name="type" value="borrowed" class="text-primary">
                            <span class="text-sm font-semibold">Me pagaron</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-600">Monto (S/.) *</label>
                    <input type="number" step="0.01" min="0.1" name="amount" required class="mt-2 w-full border border-gray-200 rounded-2xl px-4 py-3 focus:ring-2 focus:ring-primary outline-none" placeholder="0.00">
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-600">M√©todo *</label>
                    <select name="payment_method" class="mt-2 w-full border border-gray-200 rounded-2xl px-4 py-3" required>
                        <option value="cash">Efectivo</option>
                        <option value="card">Tarjeta</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-600">Categor√≠a *</label>
                    <select name="category" class="mt-2 w-full border border-gray-200 rounded-2xl px-4 py-3" required>
                        <option value="menu">Men√∫ / Comida</option>
                        <option value="taxi">Taxi / Transporte</option>
                        <option value="shared">Gasto compartido</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-600">Fecha</label>
                    <input type="date" name="date" class="mt-2 w-full border border-gray-200 rounded-2xl px-4 py-3">
                </div>
                <div class="md:col-span-2">
                    <label class="text-sm font-semibold text-gray-600">Descripci√≥n</label>
                    <input type="text" name="description" class="mt-2 w-full border border-gray-200 rounded-2xl px-4 py-3" placeholder="Ej: Taxi de regreso">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full flex items-center justify-center gap-2 bg-primary text-white font-semibold rounded-2xl py-3 hover:bg-cyan-700 transition">
                        <i class="fas fa-paper-plane"></i>
                        Registrar
                    </button>
                </div>
                <p class="md:col-span-2 text-xs text-gray-400">Los registros quedan pendientes por defecto hasta que se marquen como pagados desde la vista principal.</p>
            </form>
        </section>
    </div>

    <div id="public-loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="flex flex-col items-center gap-4">
            <div class="w-16 h-16 rounded-full border-4 border-gray-200 border-t-primary animate-spin"></div>
            <p class="text-sm font-semibold text-gray-600">Procesando...</p>
        </div>
    </div>

    <div id="public-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
        <div class="px-5 py-3 rounded-2xl shadow-lg text-white font-semibold flex items-center gap-2"></div>
    </div>

    <script>
        let publicLoans = [];
        let publicFilter = 'all';

        const categoryBadges = {
            menu: { icon: 'üçî', label: 'Men√∫' },
            taxi: { icon: 'üöï', label: 'Taxi' },
            shared: { icon: 'üë•', label: 'Compartido' },
            other: { icon: 'üìù', label: 'Otro' }
        };

        const paymentLabels = {
            cash: 'Efectivo',
            card: 'Tarjeta'
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadPublicLoans();
            loadPublicSummary();
            bindFilterButtons();
            bindForm();
            bindCopyLink();
        });

        async function loadPublicLoans() {
            try {
                const res = await fetchWithLoader('/api/personal-loans');
                publicLoans = await res.json();
                renderPublicLoans();
            } catch (error) {
                showToast('No se pudieron cargar los registros', 'error');
            }
        }

        async function loadPublicSummary() {
            try {
                const res = await fetch('/api/personal-loans/summary');
                const data = await res.json();
                document.getElementById('public-pending-lent').textContent = formatCurrency(data.pending_lent || 0);
                document.getElementById('public-pending-borrowed').textContent = formatCurrency(data.pending_borrowed || 0);
                document.getElementById('public-balance').textContent = formatCurrency(Math.abs(data.balance || 0));
                document.getElementById('public-balance-label').textContent = data.balance > 0 ? 'Te deben m√°s' : (data.balance < 0 ? 'Debes m√°s' : 'Todo saldado');
            } catch (error) {
                console.error(error);
            }
        }

        function renderPublicLoans() {
            let filtered = [...publicLoans];
            if (publicFilter !== 'all') {
                filtered = filtered.filter(l => l.status === publicFilter);
            }
            filtered.sort((a, b) => {
                const dateA = resolveDate(a);
                const dateB = resolveDate(b);
                return dateB - dateA;
            });

            const container = document.getElementById('public-loans-list');
            if (!filtered.length) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm">No hay registros con el filtro seleccionado.</p>';
                return;
            }

            container.innerHTML = filtered.map(renderPublicCard).join('');
        }

        function renderPublicCard(loan) {
            const { icon, label } = categoryBadges[loan.category] || categoryBadges.other;
            const statusLabel = loan.status === 'paid' ? 'Pagado' : 'Pendiente';
            const statusColor = loan.status === 'paid' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
            const typeColor = loan.type === 'lent' ? 'text-green-600' : 'text-rose-600';
            const dateStr = formatDate(resolveDate(loan));

            return `
                <article class="border border-gray-100 rounded-2xl p-4 hover:border-primary/40 transition bg-white shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${icon}</span>
                            <div>
                                <p class="text-sm font-semibold text-gray-500">${label}</p>
                                <p class="text-lg font-bold ${typeColor}">${formatCurrency(loan.amount || 0)}</p>
                            </div>
                        </div>
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusColor}">${statusLabel}</span>
                    </div>
                    <div class="mt-3 text-sm text-gray-500 flex flex-wrap gap-3">
                        <span><i class="fas fa-user-circle mr-1"></i>${loan.type === 'lent' ? 'Yo pagu√©' : 'Me pagaron'}</span>
                        <span><i class="fas fa-wallet mr-1"></i>${paymentLabels[loan.payment_method] || 'Efectivo'}</span>
                        <span><i class="fas fa-calendar mr-1"></i>${dateStr}</span>
                    </div>
                    ${loan.description ? `<p class="mt-2 text-sm text-gray-600">${loan.description}</p>` : ''}
                </article>
            `;
        }

        function bindFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    publicFilter = btn.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-primary', 'text-white'));
                    btn.classList.add('bg-primary', 'text-white');
                    renderPublicLoans();
                });
            });
        }

        function bindForm() {
            const form = document.getElementById('public-loan-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(form);
                const payload = Object.fromEntries(formData.entries());
                payload.amount = parseFloat(payload.amount);
                payload.status = 'pending';

                try {
                    const res = await fetchWithLoader('/api/personal-loans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error('Error en la creaci√≥n');

                    form.reset();
                    form.querySelector('input[name="type"][value="lent"]').checked = true;
                    showToast('Registro agregado correctamente');
                    await Promise.all([loadPublicLoans(), loadPublicSummary()]);
                } catch (error) {
                    showToast('No se pudo registrar el pr√©stamo', 'error');
                }
            });
        }

        function bindCopyLink() {
            const btn = document.getElementById('copy-link');
            btn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    showToast('Enlace copiado');
                } catch (error) {
                    showToast('No se pudo copiar el enlace', 'error');
                }
            });
        }

        function resolveDate(loan) {
            if (loan.date) {
                return new Date(loan.date);
            }
            if (loan.created_at?.seconds) {
                return new Date(loan.created_at.seconds * 1000);
            }
            return new Date();
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(amount || 0);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('public-toast');
            const box = toast.firstElementChild;
            box.textContent = message;
            box.className = `px-5 py-3 rounded-2xl shadow-lg text-white font-semibold flex items-center gap-2 ${type === 'error' ? 'bg-rose-500' : 'bg-emerald-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        async function fetchWithLoader(url, options) {
            toggleLoader(true);
            try {
                return await fetch(url, options);
            } finally {
                toggleLoader(false);
            }
        }

        function toggleLoader(show) {
            const loader = document.getElementById('public-loader');
            loader.classList.toggle('hidden', !show);
            loader.classList.toggle('flex', show);
        }
    </script>
</body>
</html>

