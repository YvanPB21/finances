{% extends "base.html" %}

{% block title %}Dashboard - Balance Financiero{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
                <i class="fas fa-chart-line text-primary"></i> Dashboard Financiero
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1" id="last-update">√öltima actualizaci√≥n: Ahora</p>
        </div>
        <button onclick="loadDashboard()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition shadow-lg">
            <i class="fas fa-sync-alt mr-2"></i> Actualizar
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <!-- Net Worth -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-100 text-sm font-medium">Patrimonio Neto</p>
                    <h2 id="net-worth" class="text-3xl font-bold mt-2">S/ 0.00</h2>
                </div>
                <div class="bg-blue-400 rounded-full p-3">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
            </div>
            <p class="text-blue-100 text-xs mt-4">Activos - Pasivos</p>
        </div>

        <!-- Total Assets -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-green-100 text-sm font-medium">Total Activos</p>
                    <h2 id="total-assets" class="text-3xl font-bold mt-2">S/ 0.00</h2>
                </div>
                <div class="bg-green-400 rounded-full p-3">
                    <i class="fas fa-arrow-up text-2xl"></i>
                </div>
            </div>
            <p class="text-green-100 text-xs mt-4">Ahorros + Efectivo</p>
        </div>

        <!-- Total Debt -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-red-100 text-sm font-medium">Deuda Total</p>
                    <h2 id="total-debt" class="text-3xl font-bold mt-2">S/ 0.00</h2>
                </div>
                <div class="bg-red-400 rounded-full p-3">
                    <i class="fas fa-arrow-down text-2xl"></i>
                </div>
            </div>
            <p id="credit-usage" class="text-red-100 text-xs mt-4">0% del cr√©dito usado</p>
        </div>

        <!-- Monthly Payment -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-orange-100 text-sm font-medium">Pago Mensual</p>
                    <h2 id="monthly-payment" class="text-3xl font-bold mt-2">S/ 0.00</h2>
                </div>
                <div class="bg-orange-400 rounded-full p-3">
                    <i class="fas fa-calendar-alt text-2xl"></i>
                </div>
            </div>
            <p class="text-orange-100 text-xs mt-4">Tarjetas + Pr√©stamos</p>
        </div>

        <!-- Savings Capacity -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-purple-100 text-sm font-medium">Capacidad Ahorro</p>
                    <h2 id="savings-capacity" class="text-3xl font-bold mt-2">S/ 0.00</h2>
                </div>
                <div class="bg-purple-400 rounded-full p-3">
                    <i class="fas fa-piggy-bank text-2xl"></i>
                </div>
            </div>
            <p class="text-purple-100 text-xs mt-4">Balance mensual</p>
        </div>
    </div>

    <!-- Financial Health Score -->
    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-lg shadow-xl p-6 text-white">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-heartbeat text-4xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold">Salud Financiera</h3>
                    <p class="text-sm opacity-90" id="health-status">Calculando...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-center">
                    <p class="text-5xl font-bold" id="health-score">0</p>
                    <p class="text-sm opacity-90">Puntuaci√≥n</p>
                </div>
                <div class="h-20 w-20">
                    <svg class="transform -rotate-90" width="80" height="80">
                        <circle cx="40" cy="40" r="35" stroke="rgba(255,255,255,0.3)" stroke-width="8" fill="none"/>
                        <circle id="health-circle" cx="40" cy="40" r="35" stroke="white" stroke-width="8" fill="none"
                                stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Income vs Expenses Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i> Ingresos vs Gastos Mensuales
            </h3>
            <div class="h-64 flex items-end justify-around gap-2 px-4">
                <div class="flex flex-col items-center flex-1">
                    <div class="w-full bg-gray-200 rounded-t-lg relative" style="height: 200px;">
                        <div id="income-bar" class="absolute bottom-0 w-full bg-gradient-to-t from-green-500 to-green-400 rounded-t-lg transition-all duration-500" style="height: 0%;"></div>
                    </div>
                    <p class="text-sm font-medium text-gray-600 mt-2">Ingresos</p>
                    <p id="income-amount" class="text-lg font-bold text-green-600">S/ 0</p>
                </div>
                <div class="flex flex-col items-center flex-1">
                    <div class="w-full bg-gray-200 rounded-t-lg relative" style="height: 200px;">
                        <div id="expenses-bar" class="absolute bottom-0 w-full bg-gradient-to-t from-red-500 to-red-400 rounded-t-lg transition-all duration-500" style="height: 0%;"></div>
                    </div>
                    <p class="text-sm font-medium text-gray-600 mt-2">Gastos</p>
                    <p id="expenses-amount" class="text-lg font-bold text-red-600">S/ 0</p>
                </div>
                <div class="flex flex-col items-center flex-1">
                    <div class="w-full bg-gray-200 rounded-t-lg relative" style="height: 200px;">
                        <div id="balance-bar" class="absolute bottom-0 w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg transition-all duration-500" style="height: 0%;"></div>
                    </div>
                    <p class="text-sm font-medium text-gray-600 mt-2">Balance</p>
                    <p id="balance-amount" class="text-lg font-bold text-blue-600">S/ 0</p>
                </div>
            </div>
        </div>

        <!-- Asset Distribution Pie Chart -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-chart-pie text-green-500 mr-2"></i> Distribuci√≥n de Activos
            </h3>
            <div class="flex items-center justify-center h-64">
                <div class="relative w-48 h-48">
                    <svg viewBox="0 0 200 200" class="transform -rotate-90">
                        <circle cx="100" cy="100" r="80" fill="none" stroke="#e5e7eb" stroke-width="40"/>
                        <circle id="savings-arc" cx="100" cy="100" r="80" fill="none" stroke="#3b82f6" stroke-width="40"
                                stroke-dasharray="0 502" stroke-linecap="round"/>
                        <circle id="cash-arc" cx="100" cy="100" r="80" fill="none" stroke="#10b981" stroke-width="40"
                                stroke-dasharray="0 502" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-800" id="assets-total">S/ 0</p>
                            <p class="text-xs text-gray-500">Total</p>
                        </div>
                    </div>
                </div>
                <div class="ml-8 space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-blue-500 rounded"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-700">Ahorros</p>
                            <p id="savings-percent" class="text-xs text-gray-500">0%</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                        <div>
                            <p class="text-sm font-medium text-gray-700">Efectivo</p>
                            <p id="cash-percent" class="text-xs text-gray-500">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Pr√©stamos -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-hand-holding-usd text-orange-500 mr-2"></i> Pr√©stamos Activos
                </h3>
                <a href="/loans" class="text-primary hover:text-blue-700 text-sm font-medium">
                    Ver todos <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div id="loans-summary" class="space-y-3">
                <div class="text-center text-gray-400 py-4">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Cargando...</p>
                </div>
            </div>
        </div>

        <!-- Tarjetas de Cr√©dito -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-credit-card text-purple-500 mr-2"></i> Tarjetas de Cr√©dito
                </h3>
                <a href="/cards" class="text-primary hover:text-blue-700 text-sm font-medium">
                    Ver todas <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div id="cards-summary" class="space-y-3">
                <div class="text-center text-gray-400 py-4">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Cargando...</p>
                </div>
            </div>
        </div>

        <!-- Cuentas de Ahorro -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-university text-blue-500 mr-2"></i> Cuentas de Ahorro
                </h3>
                <a href="/accounts" class="text-primary hover:text-blue-700 text-sm font-medium">
                    Ver todas <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div id="accounts-summary" class="space-y-3">
                <div class="text-center text-gray-400 py-4">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Cargando...</p>
                </div>
            </div>
        </div>

        <!-- Metas de Ahorro -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-bullseye text-yellow-500 mr-2"></i> Metas de Ahorro
                </h3>
                <a href="/goals" class="text-primary hover:text-blue-700 text-sm font-medium">
                    Ver todas <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div id="goals-list" class="space-y-4">
                <div class="text-center text-gray-400 py-4">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Access: Personal Loan (Destacado) -->
    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-xl p-6 text-white">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-white bg-opacity-20 rounded-full p-4">
                    <i class="fas fa-exchange-alt text-4xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold">Registro R√°pido</h3>
                    <p class="text-sm opacity-90">¬øPagaste un men√∫ o taxi? Reg√≠stralo ahora</p>
                </div>
            </div>
            <button onclick="openQuickPersonalLoanModal()"
                    class="bg-white text-green-600 px-8 py-4 rounded-lg font-bold text-lg hover:bg-green-50 transition transform hover:scale-105 shadow-lg">
                <i class="fas fa-plus-circle mr-2"></i> Registrar Pr√©stamo Personal
            </button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg shadow p-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
            <i class="fas fa-bolt text-yellow-500 mr-2"></i> Acciones R√°pidas
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
            <a href="/accounts" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-piggy-bank text-3xl text-blue-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Nueva Cuenta</span>
            </a>
            <a href="/cards" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-credit-card text-3xl text-purple-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Nueva Tarjeta</span>
            </a>
            <a href="/cash" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-money-bill-wave text-3xl text-green-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Registrar Efectivo</span>
            </a>
            <a href="/loans" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-hand-holding-usd text-3xl text-orange-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Nuevo Pr√©stamo</span>
            </a>
            <a href="/goals" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-bullseye text-3xl text-yellow-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Nueva Meta</span>
            </a>
            <a href="/budget" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-calculator text-3xl text-indigo-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Balance Mensual</span>
            </a>
            <a href="/personal-loans" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-exchange-alt text-3xl text-green-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Ver Todos</span>
            </a>
            <button onclick="loadDashboard()" class="flex flex-col items-center p-4 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition">
                <i class="fas fa-sync-alt text-3xl text-gray-500 mb-2"></i>
                <span class="text-xs text-center text-gray-700 font-medium">Actualizar</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal for Quick Personal Loan -->
<div id="personal-loan-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">
            <i class="fas fa-exchange-alt text-green-500 mr-2"></i> Registro R√°pido
        </h2>
        <form id="personal-loan-form" class="space-y-4">
            <!-- Tipo -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">¬øQui√©n pag√≥? *</label>
                <select id="pl-type" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="lent">üü¢ Yv√°n pag√≥ (me deben)</option>
                    <option value="borrowed">üîµ Otro pag√≥ (yo debo)</option>
                </select>
            </div>

            <!-- Monto -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Monto *</label>
                <input type="number" id="pl-amount" required step="0.01" min="0.01"
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                       placeholder="0.00" autofocus>
            </div>

            <!-- Categor√≠a -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">¬øPara qu√©? *</label>
                <select id="pl-category" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="menu">üçî Men√∫ / Comida</option>
                    <option value="taxi">üöï Taxi / Transporte</option>
                    <option value="shared">üë• Gasto Compartido</option>
                    <option value="other">üìù Otro</option>
                </select>
            </div>

            <!-- M√©todo de pago -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">¬øC√≥mo pagaste? *</label>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="selectPaymentMethod('cash')"
                            id="btn-cash"
                            class="payment-method-btn flex flex-col items-center p-4 border-2 border-green-500 bg-green-50 rounded-lg hover:bg-green-100 transition">
                        <i class="fas fa-money-bill-wave text-3xl text-green-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-700">Efectivo</span>
                    </button>
                    <button type="button" onclick="selectPaymentMethod('card')"
                            id="btn-card"
                            class="payment-method-btn flex flex-col items-center p-4 border-2 border-gray-300 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-50 transition">
                        <i class="fas fa-credit-card text-3xl text-purple-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-700">Tarjeta</span>
                    </button>
                </div>
                <input type="hidden" id="pl-payment-method" value="cash" required>
            </div>

            <!-- Descripci√≥n (opcional) -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">Descripci√≥n (opcional)</label>
                <input type="text" id="pl-description"
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                       placeholder="Ej: Almuerzo con amigos">
            </div>

            <div class="flex space-x-3 pt-4">
                <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-lg hover:from-green-600 hover:to-green-700 transition font-bold">
                    <i class="fas fa-check mr-2"></i> Guardar
                </button>
                <button type="button" onclick="closePersonalLoanModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 transition font-bold">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let dashboardData = {
        summary: null,
        loans: [],
        cards: [],
        accounts: [],
        goals: [],
        budget: null
    };

    async function loadDashboard() {
        try {
            // Update timestamp
            const now = new Date();
            document.getElementById('last-update').textContent = `√öltima actualizaci√≥n: ${now.toLocaleTimeString('es-PE')}`;

            // Load all data with loader
            await Promise.all([
                loadSummary(),
                loadLoans(),
                loadCards(),
                loadAccounts(),
                loadGoals(),
                loadBudget()
            ]);

            // Calculate financial health
            calculateFinancialHealth();

            // Update charts
            updateCharts();

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showToast('Error al cargar el dashboard', 'error');
        }
    }

    async function loadSummary() {
        const res = await fetchWithLoader('/api/summary');
        dashboardData.summary = await res.json();
        const summary = dashboardData.summary;

        // Update summary cards
        document.getElementById('net-worth').textContent = formatCurrency(summary.net_worth);
        document.getElementById('total-assets').textContent = formatCurrency(summary.total_assets);
        document.getElementById('total-debt').textContent = formatCurrency(summary.total_debt);
        document.getElementById('credit-usage').textContent = `${summary.credit_usage_percent.toFixed(1)}% del cr√©dito usado`;
    }

    async function loadLoans() {
        const res = await fetch('/api/loans');
        dashboardData.loans = await res.json();
        const loans = dashboardData.loans;
        const container = document.getElementById('loans-summary');

        const activeLoans = loans.filter(l => l.remaining_amount > 0);

        if (activeLoans.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No hay pr√©stamos activos</p>';
            return;
        }

        container.innerHTML = activeLoans.slice(0, 3).map(loan => `
            <div class="p-3 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg border border-orange-200">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 text-sm">${loan.name}</p>
                        <p class="text-xs text-gray-600">${loan.lender || 'Sin entidad'}</p>
                    </div>
                    <span class="text-xs font-bold text-orange-600">${loan.progress.toFixed(0)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-gradient-to-r from-orange-400 to-orange-500 h-2 rounded-full" style="width: ${loan.progress}%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-600">
                    <span>Pago: ${formatCurrency(loan.monthly_payment || 0)}/mes</span>
                    <span>Resta: ${formatCurrency(loan.remaining_amount)}</span>
                </div>
            </div>
        `).join('');

        // Calculate total monthly loan payment
        const totalLoanPayment = activeLoans.reduce((sum, loan) => sum + (loan.monthly_payment || 0), 0);
        return totalLoanPayment;
    }

    async function loadCards() {
        const res = await fetch('/api/cards');
        dashboardData.cards = await res.json();
        const cards = dashboardData.cards;
        const container = document.getElementById('cards-summary');

        if (cards.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No hay tarjetas registradas</p>';
            return;
        }

        container.innerHTML = cards.slice(0, 3).map(card => {
            const usagePercent = card.credit_limit > 0 ? (card.current_balance / card.credit_limit * 100) : 0;
            const available = (card.credit_limit || 0) - (card.current_balance || 0);
            return `
                <div class="p-3 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg border border-purple-200">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <p class="font-semibold text-gray-800 text-sm">${card.name}</p>
                            <p class="text-xs text-gray-600">${card.bank || 'Sin banco'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-purple-600 text-sm">${formatCurrency(card.current_balance || 0)}</p>
                            <p class="text-xs text-gray-500">de ${formatCurrency(card.credit_limit || 0)}</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-purple-400 to-purple-500 h-2 rounded-full" style="width: ${Math.min(usagePercent, 100)}%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-xs">
                        <span class="text-gray-600">${usagePercent.toFixed(1)}% usado</span>
                        <span class="text-green-600 font-medium">${formatCurrency(available)} disponible</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadAccounts() {
        const res = await fetch('/api/accounts');
        dashboardData.accounts = await res.json();
        const accounts = dashboardData.accounts;
        const container = document.getElementById('accounts-summary');

        if (accounts.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No hay cuentas registradas</p>';
            return;
        }

        container.innerHTML = accounts.slice(0, 3).map(acc => `
            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                <div>
                    <p class="font-semibold text-gray-800 text-sm">${acc.name}</p>
                    <p class="text-xs text-gray-600">${acc.bank || 'Sin banco'} ‚Ä¢ ${acc.currency || 'PEN'}</p>
                </div>
                <p class="font-bold text-blue-600">${formatCurrency(acc.balance || 0)}</p>
            </div>
        `).join('');
    }

    async function loadGoals() {
        const res = await fetch('/api/goals');
        dashboardData.goals = await res.json();
        const goals = dashboardData.goals;
        const container = document.getElementById('goals-list');

        if (goals.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No hay metas configuradas</p>';
            return;
        }

        container.innerHTML = goals.slice(0, 3).map(goal => `
            <div class="p-3 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg border border-yellow-200">
                <div class="flex justify-between mb-2">
                    <span class="font-semibold text-gray-800 text-sm">${goal.name}</span>
                    <span class="text-xs text-gray-600">${formatCurrency(goal.current_amount || 0)} / ${formatCurrency(goal.target_amount || 0)}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-3 rounded-full flex items-center justify-end pr-2" style="width: ${Math.min(goal.progress, 100)}%">
                        <span class="text-xs font-bold text-white">${goal.progress.toFixed(0)}%</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function loadBudget() {
        try {
            const res = await fetch('/api/budget/calculate');
            dashboardData.budget = await res.json();
            const budget = dashboardData.budget;

            // Update monthly payment cards
            const monthlyPayment = (budget.loans_payment || 0) + (budget.cards_payment || 0);
            document.getElementById('monthly-payment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('savings-capacity').textContent = formatCurrency(budget.savings_capacity || 0);

        } catch (error) {
            console.error('Error loading budget:', error);
            // If budget doesn't exist, show 0
            document.getElementById('monthly-payment').textContent = formatCurrency(0);
            document.getElementById('savings-capacity').textContent = formatCurrency(0);
        }
    }

    function calculateFinancialHealth() {
        const summary = dashboardData.summary;
        const budget = dashboardData.budget;

        let score = 50; // Base score
        let status = 'Regular';

        // Factor 1: Ratio deuda/activos (30 points)
        if (summary.total_assets > 0) {
            const debtRatio = summary.total_debt / summary.total_assets;
            if (debtRatio < 0.3) score += 30;
            else if (debtRatio < 0.5) score += 20;
            else if (debtRatio < 0.7) score += 10;
        }

        // Factor 2: Uso de cr√©dito (20 points)
        if (summary.credit_usage_percent < 30) score += 20;
        else if (summary.credit_usage_percent < 50) score += 15;
        else if (summary.credit_usage_percent < 70) score += 10;
        else if (summary.credit_usage_percent < 90) score += 5;

        // Factor 3: Capacidad de ahorro (20 points)
        if (budget && budget.balance > 0) {
            const savingsRatio = budget.salary > 0 ? (budget.balance / budget.salary) : 0;
            if (savingsRatio > 0.3) score += 20;
            else if (savingsRatio > 0.2) score += 15;
            else if (savingsRatio > 0.1) score += 10;
            else if (savingsRatio > 0) score += 5;
        }

        // Factor 4: Patrimonio neto positivo (10 points)
        if (summary.net_worth > 0) score += 10;

        // Determine status
        if (score >= 90) status = '¬°Excelente! üéâ';
        else if (score >= 75) status = 'Muy Buena üëç';
        else if (score >= 60) status = 'Buena ‚úì';
        else if (score >= 40) status = 'Regular ‚ö†Ô∏è';
        else status = 'Necesita Atenci√≥n üö®';

        // Update UI
        document.getElementById('health-score').textContent = score;
        document.getElementById('health-status').textContent = status;

        // Animate circle
        const circle = document.getElementById('health-circle');
        const circumference = 2 * Math.PI * 35; // r=35
        const offset = circumference - (score / 100 * circumference);
        circle.style.strokeDashoffset = offset;

        // Change color based on score
        if (score >= 75) circle.style.stroke = '#10b981'; // green
        else if (score >= 50) circle.style.stroke = '#f59e0b'; // yellow
        else circle.style.stroke = '#ef4444'; // red
    }

    function updateCharts() {
        const summary = dashboardData.summary;
        const budget = dashboardData.budget;

        // Income vs Expenses Chart
        if (budget) {
            const maxValue = Math.max(budget.salary, budget.total_expenses, 1);
            const incomePercent = (budget.salary / maxValue * 100);
            const expensesPercent = (budget.total_expenses / maxValue * 100);
            const balancePercent = (Math.max(budget.balance, 0) / maxValue * 100);

            document.getElementById('income-bar').style.height = incomePercent + '%';
            document.getElementById('expenses-bar').style.height = expensesPercent + '%';
            document.getElementById('balance-bar').style.height = balancePercent + '%';

            document.getElementById('income-amount').textContent = formatCurrency(budget.salary);
            document.getElementById('expenses-amount').textContent = formatCurrency(budget.total_expenses);
            document.getElementById('balance-amount').textContent = formatCurrency(budget.balance);
        }

        // Asset Distribution Pie Chart
        const total = summary.total_assets;
        document.getElementById('assets-total').textContent = formatCurrency(total);

        if (total > 0) {
            const savingsPercent = (summary.total_savings / total * 100);
            const cashPercent = (summary.total_cash / total * 100);

            document.getElementById('savings-percent').textContent = savingsPercent.toFixed(1) + '%';
            document.getElementById('cash-percent').textContent = cashPercent.toFixed(1) + '%';

            // Calculate arc lengths (circumference = 2œÄr = 2œÄ*80 ‚âà 502)
            const circumference = 502;
            const savingsArc = (savingsPercent / 100) * circumference;
            const cashArc = (cashPercent / 100) * circumference;

            document.getElementById('savings-arc').setAttribute('stroke-dasharray', `${savingsArc} ${circumference}`);
            document.getElementById('cash-arc').setAttribute('stroke-dasharray', `${cashArc} ${circumference}`);
            document.getElementById('cash-arc').setAttribute('stroke-dashoffset', `-${savingsArc}`);
        }
    }

    // ========== Personal Loan Modal Functions ==========
    let selectedPaymentMethod = 'cash';

    function openQuickPersonalLoanModal() {
        document.getElementById('personal-loan-form').reset();
        selectedPaymentMethod = 'cash';
        updatePaymentMethodButtons();
        document.getElementById('pl-payment-method').value = 'cash';
        document.getElementById('personal-loan-modal').classList.remove('hidden');
        document.getElementById('personal-loan-modal').classList.add('flex');
        // Focus on amount input
        setTimeout(() => {
            document.getElementById('pl-amount').focus();
        }, 100);
    }

    function closePersonalLoanModal() {
        document.getElementById('personal-loan-modal').classList.add('hidden');
        document.getElementById('personal-loan-modal').classList.remove('flex');
    }

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        document.getElementById('pl-payment-method').value = method;
        updatePaymentMethodButtons();
    }

    function updatePaymentMethodButtons() {
        const btnCash = document.getElementById('btn-cash');
        const btnCard = document.getElementById('btn-card');

        if (selectedPaymentMethod === 'cash') {
            btnCash.className = 'payment-method-btn flex flex-col items-center p-4 border-2 border-green-500 bg-green-50 rounded-lg hover:bg-green-100 transition';
            btnCard.className = 'payment-method-btn flex flex-col items-center p-4 border-2 border-gray-300 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-50 transition';
        } else {
            btnCash.className = 'payment-method-btn flex flex-col items-center p-4 border-2 border-gray-300 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-50 transition';
            btnCard.className = 'payment-method-btn flex flex-col items-center p-4 border-2 border-purple-500 bg-purple-50 rounded-lg hover:bg-purple-100 transition';
        }
    }

    // Handle form submission
    document.getElementById('personal-loan-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            type: document.getElementById('pl-type').value,
            amount: parseFloat(document.getElementById('pl-amount').value) || 0,
            category: document.getElementById('pl-category').value,
            payment_method: document.getElementById('pl-payment-method').value,
            description: document.getElementById('pl-description').value,
            date: new Date().toISOString().split('T')[0]
        };

        try {
            const res = await fetchWithLoader('/api/personal-loans', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const typeText = data.type === 'lent' ? 'Yv√°n pag√≥' : 'Otro pag√≥';
                showToast(`‚úÖ ${typeText} - ${formatCurrency(data.amount)} registrado`);
                closePersonalLoanModal();
                // Opcional: recargar dashboard para actualizar estad√≠sticas
                // await loadDashboard();
            } else {
                showToast('Error al guardar', 'error');
            }
        } catch (error) {
            console.error('Error saving personal loan:', error);
            showToast('Error al guardar', 'error');
        }
    });

    // Close modal when clicking outside
    document.getElementById('personal-loan-modal').addEventListener('click', (e) => {
        if (e.target.id === 'personal-loan-modal') {
            closePersonalLoanModal();
        }
    });

    // Load dashboard on page load
    loadDashboard();
</script>
{% endblock %}
