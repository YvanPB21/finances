{% extends "base.html" %}

{% block title %}Cuentas de Ahorro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
            <i class="fas fa-piggy-bank text-blue-500"></i> Cuentas de Ahorro
        </h1>
        <button onclick="openAddModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition shadow-lg">
            <i class="fas fa-plus mr-2"></i> Agregar Cuenta
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <p class="text-gray-600 dark:text-gray-300 text-sm font-medium">Total Ahorrado</p>
            <h2 id="total-balance" class="text-3xl font-bold text-green-600 mt-2">$0.00</h2>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <p class="text-gray-600 dark:text-gray-300 text-sm font-medium">Número de Cuentas</p>
            <h2 id="account-count" class="text-3xl font-bold text-gray-800 dark:text-white mt-2">0</h2>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <p class="text-gray-600 dark:text-gray-300 text-sm font-medium">Promedio por Cuenta</p>
            <h2 id="average-balance" class="text-3xl font-bold text-blue-600 mt-2">$0.00</h2>
        </div>
    </div>

    <!-- Accounts List -->
    <div id="accounts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Accounts will be loaded here -->
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="account-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-md w-full">
        <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Agregar Cuenta</h2>
        <form id="account-form" class="space-y-4">
            <input type="hidden" id="account-id">
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Nombre de la cuenta *</label>
                <input type="text" id="account-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ej: Cuenta de Ahorros Principal">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Banco</label>
                <input type="text" id="account-bank" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ej: BBVA">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Saldo actual *</label>
                <input type="number" id="account-balance" required step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Tipo de cuenta</label>
                <select id="account-type" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="savings">Ahorro</option>
                    <option value="checking">Cheques</option>
                    <option value="investment">Inversión</option>
                    <option value="retirement">Retiro</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Tasa de interés anual (%)</label>
                <input type="number" id="account-interest" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-200 font-medium mb-2">Moneda</label>
                <select id="account-currency" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="PEN">PEN - Nuevo Sol Peruano</option>
                    <option value="USD">USD - Dólar</option>
                    <option value="EUR">EUR - Euro</option>
                </select>
            </div>
            <div class="flex space-x-3 pt-4">
                <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-save mr-2"></i> Guardar
                </button>
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let accounts = [];

    async function loadAccounts() {
        try {
            const res = await fetch('/api/accounts');
            accounts = await res.json();
            renderAccounts();
        } catch (error) {
            console.error('Error loading accounts:', error);
            showToast('Error al cargar las cuentas', 'error');
        }
    }

    function renderAccounts() {
        const container = document.getElementById('accounts-container');
        const totalBalance = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);
        const accountCount = accounts.length;
        const averageBalance = accountCount > 0 ? totalBalance / accountCount : 0;

        document.getElementById('total-balance').textContent = formatCurrency(totalBalance);
        document.getElementById('account-count').textContent = accountCount;
        document.getElementById('average-balance').textContent = formatCurrency(averageBalance);

        if (accounts.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-piggy-bank text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No hay cuentas registradas</p>
                    <p class="text-gray-400">Agrega tu primera cuenta de ahorro</p>
                </div>
            `;
            return;
        }

        const accountTypeIcons = {
            'savings': 'fa-piggy-bank',
            'checking': 'fa-money-check',
            'investment': 'fa-chart-line',
            'retirement': 'fa-umbrella-beach'
        };

        const accountTypeNames = {
            'savings': 'Ahorro',
            'checking': 'Cheques',
            'investment': 'Inversión',
            'retirement': 'Retiro'
        };

        container.innerHTML = accounts.map(account => {
            const icon = accountTypeIcons[account.account_type] || 'fa-university';
            const typeName = accountTypeNames[account.account_type] || 'Cuenta';

            return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">${account.name}</h3>
                            <p class="text-gray-500 text-sm">${account.bank || 'Sin banco'}</p>
                            <p class="text-gray-400 text-xs mt-1">
                                <i class="fas ${icon} mr-1"></i>${typeName}
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editAccount('${account.id}')" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAccount('${account.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 dark:text-gray-300 text-sm">Saldo</span>
                                <span class="text-2xl font-bold text-green-600">${formatCurrency(account.balance || 0)}</span>
                            </div>
                        </div>
                        ${account.interest_rate ? `
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600 dark:text-gray-300">
                                <i class="fas fa-percentage mr-1"></i>Tasa de interés
                            </span>
                            <span class="text-blue-600 font-semibold">${account.interest_rate}% anual</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>
                                <i class="fas fa-coins mr-1"></i>${account.currency || 'PEN'}
                            </span>
                            ${account.updated_at ? `
                            <span>
                                <i class="fas fa-clock mr-1"></i>Actualizado: ${new Date(account.updated_at.seconds * 1000).toLocaleDateString('es-PE')}
                            </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openAddModal() {
        document.getElementById('modal-title').textContent = 'Agregar Cuenta';
        document.getElementById('account-form').reset();
        document.getElementById('account-id').value = '';
        document.getElementById('account-modal').classList.remove('hidden');
        document.getElementById('account-modal').classList.add('flex');
    }

    function editAccount(id) {
        const account = accounts.find(a => a.id === id);
        if (!account) return;

        document.getElementById('modal-title').textContent = 'Editar Cuenta';
        document.getElementById('account-id').value = id;
        document.getElementById('account-name').value = account.name;
        document.getElementById('account-bank').value = account.bank || '';
        document.getElementById('account-balance').value = account.balance || 0;
        document.getElementById('account-type').value = account.account_type || 'savings';
        document.getElementById('account-interest').value = account.interest_rate || '';
        document.getElementById('account-currency').value = account.currency || 'PEN';

        document.getElementById('account-modal').classList.remove('hidden');
        document.getElementById('account-modal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('account-modal').classList.add('hidden');
        document.getElementById('account-modal').classList.remove('flex');
    }

    async function deleteAccount(id) {
        if (!confirm('¿Estás seguro de eliminar esta cuenta?')) return;

        try {
            const res = await fetch(`/api/accounts/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                showToast('Cuenta eliminada exitosamente');
                loadAccounts();
            } else {
                throw new Error('Error al eliminar');
            }
        } catch (error) {
            console.error('Error deleting account:', error);
            showToast('Error al eliminar la cuenta', 'error');
        }
    }

    document.getElementById('account-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const accountId = document.getElementById('account-id').value;
        const data = {
            name: document.getElementById('account-name').value,
            bank: document.getElementById('account-bank').value,
            balance: parseFloat(document.getElementById('account-balance').value) || 0,
            account_type: document.getElementById('account-type').value,
            interest_rate: parseFloat(document.getElementById('account-interest').value) || null,
            currency: document.getElementById('account-currency').value
        };

        try {
            let res;
            if (accountId) {
                // Update existing account
                res = await fetch(`/api/accounts/${accountId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new account
                res = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (res.ok) {
                showToast(accountId ? 'Cuenta actualizada exitosamente' : 'Cuenta creada exitosamente');
                closeModal();
                loadAccounts();
            } else {
                throw new Error('Error al guardar');
            }
        } catch (error) {
            console.error('Error saving account:', error);
            showToast('Error al guardar la cuenta', 'error');
        }
    });

    // Close modal when clicking outside
    document.getElementById('account-modal').addEventListener('click', (e) => {
        if (e.target.id === 'account-modal') {
            closeModal();
        }
    });

    // Load accounts on page load
    loadAccounts();
</script>
{% endblock %}

